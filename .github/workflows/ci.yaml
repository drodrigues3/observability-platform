name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint-python:
    name: Lint Python (${{ matrix.app }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [workload-simulator, stream-processor, metrics-bridge]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install poetry
        run: pip install poetry==1.7.1

      - name: Install dependencies
        working-directory: apps/${{ matrix.app }}
        run: poetry install

      - name: Run ruff lint
        working-directory: apps/${{ matrix.app }}
        run: poetry run ruff check .

      - name: Run mypy type check
        working-directory: apps/${{ matrix.app }}
        run: poetry run mypy . --ignore-missing-imports

  test-python:
    name: Unit Tests (${{ matrix.app }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [workload-simulator, stream-processor, metrics-bridge]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install poetry
        run: pip install poetry==1.7.1

      - name: Install dependencies
        working-directory: apps/${{ matrix.app }}
        run: poetry install

      - name: Run tests
        working-directory: apps/${{ matrix.app }}
        run: poetry run pytest tests/ -v --tb=short

  build-and-scan:
    name: Build & Trivy Scan (${{ matrix.app }})
    runs-on: ubuntu-latest
    needs: [lint-python, test-python]
    strategy:
      matrix:
        app: [workload-simulator, stream-processor, metrics-bridge]
    permissions:
      security-events: write   # upload SARIF to GitHub Security tab
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: apps/${{ matrix.app }}
          push: false
          load: true
          tags: ${{ matrix.app }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.app }}:ci-${{ github.sha }}
          format: table
          exit-code: "1"
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Trivy SARIF report
        if: always()
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.app }}:ci-${{ github.sha }}
          format: sarif
          output: trivy-${{ matrix.app }}.sarif
          severity: CRITICAL,HIGH,MEDIUM
          ignore-unfixed: true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.app }}.sarif
          category: trivy-${{ matrix.app }}

  lint-helm:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.13.0"

      - name: Lint all charts
        run: |
          helm lint helm/workload-simulator/
          helm lint helm/stream-processor/
          helm lint helm/metrics-bridge/
          helm lint helm/observability-platform/ --set kube-prometheus-stack.enabled=false --set kafka.enabled=false

      - name: Validate templates (workload-simulator)
        run: |
          helm template obs helm/workload-simulator/ | python3 -c "
          import sys, yaml
          docs = [d for d in yaml.safe_load_all(sys.stdin) if d]
          print(f'Validated {len(docs)} Kubernetes resources from workload-simulator chart')
          for d in docs:
              print(f'  - {d[\"kind\"]}: {d[\"metadata\"][\"name\"]}')
          "

      - name: Validate templates (stream-processor)
        run: |
          helm template obs helm/stream-processor/ | python3 -c "
          import sys, yaml
          docs = [d for d in yaml.safe_load_all(sys.stdin) if d]
          print(f'Validated {len(docs)} Kubernetes resources from stream-processor chart')
          "

      - name: Validate templates (metrics-bridge)
        run: |
          helm template obs helm/metrics-bridge/ | python3 -c "
          import sys, yaml
          docs = [d for d in yaml.safe_load_all(sys.stdin) if d]
          print(f'Validated {len(docs)} Kubernetes resources from metrics-bridge chart')
          "

  validate-k8s-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          python3 -c "
          import yaml, glob, sys
          files = glob.glob('k8s/*.yaml')
          errors = []
          for f in files:
              try:
                  with open(f) as fp:
                      list(yaml.safe_load_all(fp))
                  print(f'  OK: {f}')
              except yaml.YAMLError as e:
                  errors.append(f'{f}: {e}')
          if errors:
              print('ERRORS:', errors)
              sys.exit(1)
          print(f'All {len(files)} k8s manifest files are valid YAML')
          "
